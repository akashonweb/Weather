<!-- core/templates/core/map_forecast.html -->
{% extends "base.html" %}
{% block title %}Map Forecast Entry{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container mx-auto py-6">
  <h2 class="text-2xl font-semibold mb-4">Forecast Map Entry</h2>

  <div class="mb-4">
    <label>Date: <input type="date" id="entry_date" value="{{ today }}"></label>
    <label>Horizon:
      <<select id="horizon_select">
		<option value="1">1</option>
		<option value="2">2</option>
		<option value="3">3</option>
		<option value="4">4</option>
		<option value="5">5</option>
		<option value="6">6</option>
		<option value="7">7</option>
	</select>
    </label>
  </div>

  <div id="map" style="height: 600px; border:1px solid #ddd;"></div>

  <!-- Modal-like inline form -->
  <div id="entryPanel" style="display:none; position:fixed; right:20px; top:80px; z-index:5000; background:white; padding:14px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.15); width:320px;">
    <h3 id="panelTitle">Enter forecast</h3>
    <div><strong id="districtName"></strong></div>
    <div class="mt-2">
      <label>Rainfall (mm): <input type="number" step="0.1" id="rainfall_mm" /></label>
    </div>
    <div class="mt-2">
      <label>Category: <input id="rainfall_cat" placeholder="Light/Moderate/Heavy" /></label>
    </div>
    <div class="mt-3 flex">
      <button id="saveBtn" class="btn">Save</button>
      <button id="closeBtn" class="btn ml-2">Close</button>
    </div>
  </div>
</div>

<script>
const csrftoken = "{{ csrf_token }}";  // template provides csrf_token
function getCookie(name) {
  // small fallback: if csrf_token not available, read cookie
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const CSRF = csrftoken || getCookie('csrftoken');

const map = L.map('map').setView([23.6, 87.8], 7);  // center West Bengal
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// load GeoJSON (place file in static/geojson/wb_districts.geojson)
fetch('/static/geojson/wb_districts.geojson')
  .then(r => r.json())
  .then(geojson => {
    L.geoJSON(geojson, {
      style: function(feature) {
        return {color: '#226', weight: 1, fillColor: '#88c', fillOpacity: 0.3};
      },
      onEachFeature: function(feature, layer) {
        const props = feature.properties || {};
        const dName = props.name || props.DIST_NAME || props.DISTRICT || 'Unknown';
        const dCode = props.code || props.id || props.DIST_CODE || '';
        layer.bindPopup(`<strong>${dName}</strong><br/><button onclick="openEntry('${dCode}','${dName}')">Enter forecast</button>`);
      }
    }).addTo(map);
  }).catch(err => { console.error("Failed to load geojson", err); });

let currentDistrict = null;
function openEntry(code, name) {
  currentDistrict = code;
  document.getElementById('districtName').innerText = name + " (" + code + ")";
  document.getElementById('entryPanel').style.display = 'block';
}

document.getElementById('closeBtn').addEventListener('click', () => {
  document.getElementById('entryPanel').style.display = 'none';
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!currentDistrict) { alert("Select a district first"); return; }
  const date = document.getElementById('entry_date').value;
  const horizon = parseInt(document.getElementById('horizon_select').value);
  const rainfall_mm = parseFloat(document.getElementById('rainfall_mm').value) || null;
  const rainfall_category = document.getElementById('rainfall_cat').value || null;

  // first fetch district id by code
  const q = new URLSearchParams({search: currentDistrict});
  const ds = await fetch('/api/districts/?' + q.toString(), {credentials:'include'}).then(r=>r.json());
  let districtObj = ds && ds.length ? ds[0] : null;
  if (!districtObj) {
    alert("District not found in DB. Import districts first.");
    return;
  }

  const payload = {
    district: districtObj.id,
    date: date,
    horizon: horizon,
    rainfall_mm: rainfall_mm,
    rainfall_category: rainfall_category,
    extras: {}
  };

  const resp = await fetch('/api/forecasts/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF
    },
    credentials: 'include',
    body: JSON.stringify(payload)
  });

  if (resp.ok) {
    alert("Saved.");
    document.getElementById('entryPanel').style.display = 'none';
  } else {
    const txt = await resp.text();
    alert("Error saving: " + resp.status + " " + txt);
    console.error(resp, txt);
  }
});
</script>
{% endblock %}
